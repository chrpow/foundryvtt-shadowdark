{
	"_id": "Mpv9Vw9c5k41q6q1",
	"_key": "!macros!Mpv9Vw9c5k41q6q1",
	"author": "8izGgsXsUnRdsQpK",
	"command": "// Macro for the GM that opens a menu letting you award XP to selected characters.\n// By default, XP is awarded to all player-controlled characters who are currently online.\n\nawardXP();\n\nasync function awardXP() {\n\t/* Collect all player-controlled actors */\n\tconst pcs = [];\n\tgame.users.players.forEach((p) => {\n\t\tif (pcs.indexOf(p.character) == -1 && p.character) {\n\t\t\tpcs.push(p.character);\n\t\t}\n\t});\n\n\t/* Throw warning if no available player characters*/\n\tif (pcs.length < 1) {\n\t\treturn ui.notifications.warn(\"No player characters are assigned!\");\n\t}\n\n\t/* Build dialog data */\n\tconst xpMap = new Map([\n\t\t//[0, 'Poor'],\n\t\t[1, \"Normal\"],\n\t\t[3, \"Fabulous\"],\n\t\t[10, \"Legendary\"],\n\t]);\n\n\tconst es_data = [{ label: `Treasure Quality:`, type: `select`, options: [] }];\n\n\tfor (let actor of pcs) {\n\t\tes_data.push({\n\t\t\tlabel: actor.name,\n\t\t\ttype: `checkbox`,\n\t\t\toptions: [\n\t\t\t\tgame.users.players.find((p) => p.character === actor).active\n\t\t\t\t\t? \"checked\"\n\t\t\t\t\t: \"\",\n\t\t\t],\n\t\t});\n\t}\n\tes_data.push();\n\txpMap.forEach((value, key) => {\n\t\tes_data[0].options.push([key, value]);\n\t});\n\n\t/* Run dialog and allot data */\n\tconst choice = await quickDialog({ data: es_data, title: `Award XP` });\n\tconst xpGain = choice[0];\n\tchecks = [...choice];\n\tchecks.splice(0, 1);\n\tselectedActors = [];\n\n\tfor (let i = 0; i < checks.length; i++) {\n\t\tif (checks[i]) {\n\t\t\tselectedActors.push(pcs[i]);\n\t\t}\n\t}\n\tconst dingers = [];\n\n\tfor (let actor of selectedActors) {\n\t\tlet initLevel = actor.system.level.value;\n\t\tlet initXP = actor.system.level.xp;\n\t\tactor.system.level.xp = actor.system.level.xp + 1 * xpGain;\n\t\twhile (actor.system.level.xp >= 10 * actor.system.level.value) {\n\t\t\tactor.system.level.xp -= 10 * actor.system.level.value;\n\t\t\tactor.system.level.value++;\n\t\t\tdingers.push([actor.uuid, actor.name, actor.system.level.value]);\n\t\t}\n\t\tlet newLevel = actor.system.level.value;\n\t\tlet newXP = actor.system.level.xp;\n\t\tconsole.log(\n\t\t\t`${actor.name}: LVL${initLevel}/${initXP}XP ==> LVL${newLevel}/${newXP}XP`\n\t\t);\n\t}\n\n\t/* Post message to chat */\n\tmessage = `<h2><p>The party was awarded ${xpGain} XP!</p></h2>`;\n\tdingers.forEach((x) => {\n\t\tmessage += `<p>@UUID[${x[0]}]{${x[1]}} is now Level ${x[2]}!</p>`;\n\t});\n\n\tconst chatData = {\n\t\tuser: game.user._id,\n\t\t//speaker: ChatMessage.getSpeaker(),\n\t\tcontent: message,\n\t};\n\n\tChatMessage.create(chatData, {});\n}\n/* Dialog box */\nasync function quickDialog({ data, title = `Quick Dialog` } = {}) {\n\tdata = data instanceof Array ? data : [data];\n\n\treturn await new Promise(async (resolve) => {\n\t\tlet content = `\n        <table style=\"border-collapse:collapse;border-spacing:0;border:none\" class=\"tg\"><thead><tr><th style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">Quality</th><th style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">XP</th><th style=\"border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 10px;text-align:left;vertical-align:top;word-break:normal\">Examples</th></tr></thead><tbody><tr><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">Poor</td><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">0</td><td style=\"border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:left;vertical-align:top;word-break:normal\">Bag of silver, used dagger, knucklebone dice</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">Normal</td><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">1</td><td style=\"border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:left;vertical-align:top;word-break:normal\">Bag of gold, gem, fine armor, magic scroll</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">Fabulous</td><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">3</td><td style=\"border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:left;vertical-align:top;word-break:normal\">Magic sword, giant diamond, mithral chainmail</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">Legendary</td><td style=\"border-color:inherit;border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:center;vertical-align:top;word-break:normal\">10</td><td style=\"border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 10px;text-align:left;vertical-align:top;word-break:normal\">The Staff of Ord, a djinni's wish, a dragon hoard</td></tr></tbody></table>\n\n        <table style=\"width:100%\">\n        ${data\n\t\t\t\t\t.map(({ type, label, options }, i) => {\n\t\t\t\t\t\tif (type.toLowerCase() === `select`) {\n\t\t\t\t\t\t\treturn `<tr><th style=\"width:50%\"><label>${label}</label></th><td style=\"width:50%\"><select style=\"font-size:12px\" id=\"${i}qd\">${options\n\t\t\t\t\t\t\t\t.map(\n\t\t\t\t\t\t\t\t\t(e, i) => `<option value=\"${e[0]}\">${e[0]} - ${e[1]}</option>`\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.join(``)}</td></tr>`;\n\t\t\t\t\t\t} else if (type.toLowerCase() === `checkbox`) {\n\t\t\t\t\t\t\treturn `<tr><th style=\"width:50%\"><label>${label}</label></th><td style=\"width:50%\"><input type=\"${type}\" id=\"${i}qd\" ${\n\t\t\t\t\t\t\t\toptions || ``\n\t\t\t\t\t\t\t}/></td></tr>`;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn `<tr><th style=\"width:50%\"><label>${label}</label></th><td style=\"width:50%\"><input type=\"${type}\" id=\"${i}qd\" value=\"${\n\t\t\t\t\t\t\t\toptions instanceof Array ? options[0] : options\n\t\t\t\t\t\t\t}\"/></td></tr>`;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.join(``)}\n        </table>`;\n\n\t\tawait new Dialog(\n\t\t\t{\n\t\t\t\ttitle,\n\t\t\t\tcontent,\n\t\t\t\tbuttons: {\n\t\t\t\t\tOk: {\n\t\t\t\t\t\tlabel: `Ok`,\n\t\t\t\t\t\tcallback: (html) => {\n\t\t\t\t\t\t\tresolve(\n\t\t\t\t\t\t\t\tArray(data.length)\n\t\t\t\t\t\t\t\t\t.fill()\n\t\t\t\t\t\t\t\t\t.map((e, i) => {\n\t\t\t\t\t\t\t\t\t\tlet { type } = data[i];\n\t\t\t\t\t\t\t\t\t\tif (type.toLowerCase() === `select`) {\n\t\t\t\t\t\t\t\t\t\t\treturn html.find(`select#${i}qd`).val();\n\t\t\t\t\t\t\t\t\t\t} else return html.find(`input#${i}qd`)[0].checked;\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tdefault: \"Ok\",\n\t\t\t},\n\t\t\t{ width: \"auto\" }\n\t\t)._render(true);\n\t\tdocument.getElementById(\"0qd\").focus();\n\t});\n}",
	"folder": null,
	"img": "icons/commodities/treasure/crown-gold-laurel-wreath.webp",
	"name": "Award XP",
	"scope": "global",
	"type": "script"
}
